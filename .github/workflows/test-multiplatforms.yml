name: Test Multi-Platforms

on:
  push:
    branches: [ main, cpack-builds ]
  pull_request:
    branches: [ main,  ]
  workflow_dispatch:

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
   
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake mingw-w64
    
    - name: Build Linux release
      run: |
        mkdir build-linux
        cd build-linux
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel
        cpack
    
    - name: Build Windows release
      run: |
        mkdir build-windows
        cd build-windows
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../cmake/mingw-w64-toolchain.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel
    
    - name: Package releases
      run: |
        # Create release packages
        mkdir -p releases
        
        # Linux package
        cd build-linux
        tar -czf ../releases/pug-linux-x64.tar.gz src/pug ../langlevels
        cd ..
        
        # Windows package
        cd build-windows
        zip -r ../releases/pug-windows-x64.zip src/pug.exe ../langlevels
        cd ..
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pug-releases
        path: releases/
